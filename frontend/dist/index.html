<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>解答例：簡易掲示板</title>
    <style>
        .post {
            padding: 0.5em;
            margin-bottom: 0.5em;
            border: 1px solid #CCC;
        }
    </style>
</head>
<body>
    <h1>簡易掲示板の作成</h1>
    
    <div>
        <input type="hidden" id="postId">
        名前：<input type="text" id="userName"><br>
        内容：<textarea id="userContent"></textarea><br>
        
        <button type="button" id="submitBtn">送信</button>
        <button type="button" id="editBtn" style="display: none;">編集</button>
        <button type="button" id="cancelBtn" style="display: none;">キャンセル</button>
    </div>

    <div id="app"></div>

    <script>
        const app = document.getElementById('app');

        /**
         * 2. 関数：記事一覧を取得して描画する (GET)
         */
        async function getPosts() {
            const API_LIST_URL = 'http://localhost:3000/api/list';
            try {
                const response = await fetch(API_LIST_URL, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });
                const result = await response.json();

                let htmlContents = '<h2>記事一覧</h2>';
                if (result.data.length === 0) {
                    htmlContents += '<p>記事はありません</p>';
                }

                result.data.forEach(post => {
                    htmlContents += `
                        <div class="post">
                            ${post.id} : <strong>${post.name}</strong><br>
                            ${post.content}<br>
                            <small>${post.date}</small><br>
                            <button class="delete" value="${post.id}">削除</button>
                            <button class="edit" value="${post.id}">編集</button>
                            <div id="post-${post.id}" style="display:none">
                                <span class="name">${post.name}</span>
                                <span class="content">${post.content}</span>
                            </div>
                        </div>`;
                });
                app.innerHTML = htmlContents;
            } catch (error) {
                console.error("取得エラー:", error);
            }
        }

        /**
         * 3. イベント：新規投稿 (POST)
         */
        document.getElementById('submitBtn').addEventListener('click', async function() {
            const name = document.getElementById('userName').value;
            const content = document.getElementById('userContent').value;

            if (!name || !content) {
                alert('名前と内容を入力してください');
                return;
            }

            try {
                await fetch('http://localhost:3000/api/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, content })
                });
                // フォームクリアと再取得
                document.getElementById('userName').value = '';
                document.getElementById('userContent').value = '';
                getPosts();
            } catch (error) {
                console.error("投稿エラー:", error);
            }
        });

        /**
         * 4. 関数：記事の削除 (POST)
         */
        async function deletePost(id) {
            try {
                await fetch('http://localhost:3000/api/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: parseInt(id) })
                });
                getPosts();
            } catch (error) {
                console.error("削除エラー:", error);
            }
        }

        /**
         * 5 & 6. 編集関連：イベント委譲と編集確定
         */
        // 編集ボタン・削除ボタンのイベント委譲
        app.addEventListener('click', function(e) {
            const id = e.target.value;
            if (e.target.classList.contains('delete')) {
                if(confirm('削除しますか？')) deletePost(id);
            }
            
            if (e.target.classList.contains('edit')) {
                const editData = document.getElementById('post-' + id);
                document.getElementById('postId').value = id;
                document.getElementById('userName').value = editData.querySelector('.name').textContent;
                document.getElementById('userContent').value = editData.querySelector('.content').textContent;

                document.getElementById('submitBtn').style.display = 'none';
                document.getElementById('editBtn').style.display = 'inline-block';
                document.getElementById('cancelBtn').style.display = 'inline-block';
            }
        });

        // 編集確定ボタン
        document.getElementById('editBtn').addEventListener('click', async function() {
            const id = document.getElementById('postId').value;
            const name = document.getElementById('userName').value;
            const content = document.getElementById('userContent').value;

            try {
                await fetch('http://localhost:3000/api/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: parseInt(id), name, content })
                });
                document.getElementById('cancelBtn').click(); // フォームリセット
                getPosts();
            } catch (error) {
                console.error("編集エラー:", error);
            }
        });

        /**
         * 7. イベント：編集のキャンセル
         */
        document.getElementById('cancelBtn').addEventListener('click', function() {
            document.getElementById('postId').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userContent').value = '';
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
        });

        /**
         * 8. 初期実行
         */
        document.addEventListener('DOMContentLoaded', getPosts);
    </script>
</body>
</html>